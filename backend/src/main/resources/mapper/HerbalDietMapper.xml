<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tcm.platform.mapper.HerbalDietMapper">

    <select id="selectDietPage" resultType="com.tcm.platform.entity.HerbalDiet">
        SELECT * FROM herbal_diet
        WHERE 1=1
        <if test="keyword != null and keyword != ''">
            AND (diet_name LIKE CONCAT('%', #{keyword}, '%')
            OR description LIKE CONCAT('%', #{keyword}, '%')
            OR efficacy LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        <if test="difficulty != null and difficulty != ''">
            AND difficulty_level = #{difficulty}
        </if>
        ORDER BY created_at DESC
    </select>

    <update id="incrementViewsCount">
        UPDATE herbal_diet
        SET views_count = views_count + 1
        WHERE diet_id = #{dietId}
    </update>

    <update id="incrementCollectionCount">
        UPDATE herbal_diet
        SET collection_count = collection_count + 1
        WHERE diet_id = #{dietId}
    </update>

    <update id="decrementCollectionCount">
        UPDATE herbal_diet
        SET collection_count = collection_count - 1
        WHERE diet_id = #{dietId} AND collection_count > 0
    </update>

</mapper>
